<!-- include Uploadcare widget (already had this) -->
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js" defer></script>

<!-- CSS to hide some helper text inside Uploadcare widget (best-effort) -->
<style>
/* Try to hide the small "optional" or size hint. Widget internals may change; adjust if needed. */
.uploadcare--widget__button,
.uploadcare--widget__file {
  /* keep default */
}
.uploadcare--widget__dragndrop-hint,
.uploadcare--widget__file-info {
  display: none !important;
}
</style>

<!-- Form (in your modal) -->
<form id="supportForm">
  <label>Title</label>
  <input id="title" name="title" required />
  <label>Message</label>
  <textarea id="message" name="message" rows="4" required></textarea>

  <!-- Uploadcare uploader: multiple + 100MB max -->
  <input
    type="hidden"
    role="uploadcare-uploader"
    name="attachment"
    data-public-key="93421cc4c0211b5c1d86"
    data-multiple="true"
    data-max-size="104857600"
  />

  <button type="submit">Send</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // get widget instance (Uploadcare creates it automatically)
  const widget = uploadcare.Widget('[role=uploadcare-uploader]');

  const supportForm = document.getElementById('supportForm');
  supportForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const title = document.getElementById('title').value.trim();
    const message = document.getElementById('message').value.trim();

    // widget.value() returns string(s) of file UUID(s) or empty
    // For multiple files it returns something like "uuid1,uuid2" or will return a value object/promise;
    // safe approach: use widget.value(true) to get array of FileInfo objects (if available).
    // But simplest: get the CDN URLs via widget.value() then map to CDN urls.
    let filesValue = widget.value(); // may be string or null
    // If widget.value() returns a Promise when using storage API, handle accordingly:
    if (filesValue && typeof filesValue.then === 'function') {
      // If widget.value() returns a promise (for FileInfo), resolve it
      try {
        filesValue = await filesValue;
      } catch (err) {
        console.error('Uploadcare value error', err);
        filesValue = null;
      }
    }

    // Normalize files into array of CDN URLs (string)
    // If filesValue is a string like "uuid1 uuid2" or "uuid1,uuid2"
    let fileUrls = [];
    if (!filesValue) {
      fileUrls = [];
    } else if (typeof filesValue === 'string') {
      // could be "uuid" or "uuid,uuid2" or "https://ucarecdn..."
      const parts = filesValue.split(/\s*,\s*|\s+/).filter(Boolean);
      fileUrls = parts.map(p => {
        if (p.startsWith('https://')) return p; // already URL
        return `https://ucarecdn.com/${p}/`; // CDN URL pattern (works for single files)
      });
    } else if (Array.isArray(filesValue)) {
      // FileInfo objects — try file.cdnUrl or file.cdnUrl + '/'
      fileUrls = filesValue.map(f => f.cdnUrl || (f.cdnUrl ? `${f.cdnUrl}/` : ''));
    } else if (filesValue.cdnUrl) {
      fileUrls = [filesValue.cdnUrl];
    }

    // Build payload: send array of file URLs (or empty array)
    const payload = { title, message, attachments: fileUrls };

    try {
      await fetch('https://formspree.io/f/mgvnbbaw', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch (err) {
      console.error('Form submit error', err);
    } finally {
      // Reset everything: modal close handled elsewhere
      supportForm.reset();
      // clear Uploadcare widget
      try {
        uploadcare.Widget('[role=uploadcare-uploader]').value(null);
      } catch (err) {
        console.warn('Couldn’t reset uploadcare widget via API', err);
      }
    }
  });
});
      </script>
